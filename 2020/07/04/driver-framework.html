<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		



		<title>Linux -- Driver framework</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="../../../../assets/css/main.css" />
		<link rel="stylesheet" href="../../../../assets/css/syntax.css">
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
						<div class="inner">

							<!-- Header -->
																  <script type="text/x-mathjax-config">
								    MathJax.Hub.Config({
								      tex2jax: {
								        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
								        inlineMath: [['$','$']]
								      }
								    });
								  </script>
								  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>


								<header id="header">
									<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
									<a href="../../../../index.html" class="logo"><strong>Follow Jietang</strong> with:</a>
									<ul class="icons">
										<li><a href="mailto:alvin.tang6@gmail.com" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
										
										<!--<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li> -->
										<li><a href="https://github.com/Alvintang6" class="icon brands fa-github-square"><span class="label">Github</span></a></li>
										<li><a href="https://www.instagram.com/tang12y/?hl=en" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
										<li><a href="https://www.linkedin.com/in/jie-tang-55070b148/" class="icon brands fa-linkedin-in"><span class="label">Linkedin</span></a></li>
										<li><a href="../../../../resume_jietang.pdf" class="logo"><i class="fas fa-file-invoice"></i>CV</a></li>
									</ul>
								</header>


							


								

							<!-- Content -->
								<section>
									<header class="main">
										<h1>Linux -- Driver framework</h1>
										<p>04 Jul 2020</p>
									</header>
									 
									


									<h3><i class="fas fa-tags"></i>Post Tags</h3>
									
									<a href=" ../../../../tag/linux/index.html" >Linux</a>
									
									<a href=" ../../../../tag/kernel/index.html" >kernel</a>
									
									<a href=" ../../../../tag/device-tree/index.html" >Device-tree</a>
									
									<br/>
									<br/>

									<ul id="markdown-toc">
  <li><a href="#general-device-driver-framework" id="markdown-toc-general-device-driver-framework">General device driver framework</a></li>
  <li><a href="#1-driver-with-device-tree-and-busi2c-bus-for-example" id="markdown-toc-1-driver-with-device-tree-and-busi2c-bus-for-example">1. Driver with device tree and bus(i2c bus for example)</a>    <ul>
      <li><a href="#11-framework-of-i2c-device-driver-based-on-i2c-bus" id="markdown-toc-11-framework-of-i2c-device-driver-based-on-i2c-bus">1.1 Framework of i2c device driver based on i2c bus</a></li>
    </ul>
  </li>
  <li><a href="#2-driver-with-device-tree-and-platform" id="markdown-toc-2-driver-with-device-tree-and-platform">2. Driver with device tree and platform</a>    <ul>
      <li><a href="#21" id="markdown-toc-21">2.1</a></li>
    </ul>
  </li>
</ul>

<h2 id="general-device-driver-framework">General device driver framework</h2>

<p>A typical character device driver may include following components.</p>

<p>1.initial &amp; exit function (initial and delete driver module)<br />
2.register &amp; unregister function (inside initial, exit function and used for configurating operations of drivers)<br />
3.file_operation structure (include basic operation accept by drives like: open,read,write and etc..)</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
</pre></td><td class="code"><pre><span class="cp">#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/cdev.h&gt;
#include &lt;linux/uaccess.h&gt;
#include &lt;linux/types.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/delay.h&gt;
#include &lt;linux/ide.h&gt;
#include &lt;linux/errno.h&gt;
#include &lt;asm/mach/map.h&gt;
#include &lt;asm/io.h&gt;
#include &lt;linux/device.h&gt;
</span>
<span class="cp">#define DEV_NAME "Embedchrdev"
#define DEV_CNT (1)
</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chr_dev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">){</span>
	<span class="cm">/* Todo */</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">"chrdevtest_open </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chr_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">){</span>
	<span class="cm">/* Todo */</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">"chrdevtest_release </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">chr_dev_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* Todo */</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">"chrdevtest_read </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">chr_dev_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* Todo */</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">"chrdevtest_write </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="p">}</span>

<span class="c1">// pack the chrdev property inside a structure</span>
<span class="k">struct</span> <span class="n">chrdev_dev</span><span class="p">{</span>
	<span class="n">dev_t</span> <span class="n">devid</span><span class="p">;</span><span class="cm">/* deviceid */</span>
  	<span class="k">struct</span> <span class="n">cdev</span> <span class="n">cdev</span><span class="p">;</span> 
  	<span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">class</span><span class="p">;</span> <span class="cm">/* class */</span>
  	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span> <span class="cm">/* device */</span>
  	<span class="kt">int</span> <span class="n">major</span><span class="p">;</span> <span class="cm">/* major devid */</span>
  	<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>
  	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">rgb_led_node</span><span class="p">;</span> <span class="cm">/* rgb_led root node */</span>
<span class="p">};</span>



<span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">chr_dev_fops</span><span class="o">=</span><span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="c1">// some operations are optional depends on usage</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">chr_dev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">chr_dev_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">chr_dev_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">chr_dev_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">chrdev_dev</span> <span class="n">chrdev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">chrdev_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
 <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="n">printk</span><span class="p">(</span><span class="s">"chrdev init</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="c1">// step (1). register device and/or get device id</span>
 
 

 <span class="k">if</span> <span class="p">(</span><span class="n">chrdev</span><span class="p">.</span><span class="n">major</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* using defineded deivce number */</span>
        <span class="n">chrdev</span><span class="p">.</span><span class="n">devid</span> <span class="o">=</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">chrdev</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">register_chrdev_region</span><span class="p">(</span><span class="n">chrdev</span><span class="p">.</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_CNT</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    <span class="cm">/* not defined the device number */</span>
		<span class="c1">// device name is 'EmbedCharDev'， can be checked with cat /proc/devices</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_chrdev_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chrdev</span><span class="p">.</span><span class="n">devid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DEV_CNT</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">);</span> <span class="cm">/* apply for device number */</span> 
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">"fail to alloc devno</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 			<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>
 		<span class="p">}</span>
        <span class="n">chrdev</span><span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">chrdev</span><span class="p">.</span><span class="n">devid</span><span class="p">);</span> <span class="cm">/* get major device number */</span> 
        <span class="n">chrdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">chrdev</span><span class="p">.</span><span class="n">devid</span><span class="p">);</span> <span class="cm">/* get minor device number */</span>
    <span class="p">}</span> 

 
 <span class="c1">//Step (2). match the char device with file operations structure and functions.</span>
 <span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chrdev</span><span class="p">.</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chr_dev_fops</span><span class="p">);</span>

 <span class="c1">//Step (3)</span>
 <span class="c1">//add chrdev to cdev_map list</span>
 <span class="n">ret</span> <span class="o">=</span> <span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chrdev</span><span class="p">.</span><span class="n">cdev</span><span class="p">,</span> <span class="n">chrdev</span><span class="p">.</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_CNT</span><span class="p">);</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="n">printk</span><span class="p">(</span><span class="s">"fail to add cdev</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="k">goto</span> <span class="n">add_err</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


 <span class="nl">add_err:</span>
 <span class="c1">//if add char device failed， unregister the chrdev</span>
 <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">chrdev</span><span class="p">.</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_CNT</span><span class="p">);</span>
 <span class="nl">alloc_err:</span>
 <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">chrdev_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
	 <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">chrdev</span><span class="p">.</span><span class="n">devid</span><span class="p">,</span> <span class="n">DEV_CNT</span><span class="p">);</span>
	 <span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chrdev</span><span class="p">.</span><span class="n">cdev</span><span class="p">);</span>
 <span class="p">}</span>


 <span class="n">module_init</span><span class="p">(</span><span class="n">chrdev_init</span><span class="p">);</span>
 <span class="n">module_exit</span><span class="p">(</span><span class="n">chrdev_exit</span><span class="p">);</span>
 <span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="1-driver-with-device-tree-and-busi2c-bus-for-example">1. Driver with device tree and bus(i2c bus for example)</h2>

<p>The main framework of bus based driver is similar with general framework, but added device_driver match table which is used to match the driver with device(device tree or device resource file).</p>

<h3 id="11-framework-of-i2c-device-driver-based-on-i2c-bus">1.1 Framework of i2c device driver based on i2c bus</h3>

<p>The <code class="highlighter-rouge">i2c_driver</code> is used to characterize the property of a i2c device.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">gtp_device_id</span><span class="p">[]</span> <span class="o">=</span><span class="p">{</span>
    <span class="p">{</span><span class="s">"jie,i2c_mpu6050"</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
    <span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpu6050_match_table</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
    <span class="p">{.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">"jie,i2c_mpu6050"</span><span class="p">},</span>
    <span class="p">{</span><span class="cm">/* Sentinel */</span><span class="p">}</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">mpu6050_driver</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">mpu6050_probe</span><span class="p">,</span>
    <span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">mpu6050_remove</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">gtp_device_id</span><span class="p">,</span>
    <span class="p">.</span><span class="n">driver</span> <span class="o">=</span><span class="p">{</span>
            <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"mpu6050"</span><span class="p">,</span>
            <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
            <span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">mpu6050_match_table</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">};</span>

</code></pre></div></div>

<p>The .probe indicate the initial functional which will be loaded when mpu6050_driver match with a device. Most of time in .probe we only register and add the device.</p>

<p>The .of_match_table and .id_table will compare and match the driver with a device tree or board-level resource files. Following is a i2c device tree node and the property of compatible will be matched with mpu6050_match_table and gtp_device_id.</p>

<p>THe main purpose of <code class="highlighter-rouge">.of_match_table</code> and <code class="highlighter-rouge">.i2c_device_id</code> is same. The only difference between them is priority. System will try match with <code class="highlighter-rouge">.of_match_table</code> first if there is no rules, it will try to match with <code class="highlighter-rouge">.i2c_device_id</code> .</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&amp;</span><span class="n">i2c1</span> <span class="p">{</span>
	<span class="n">clock</span><span class="o">-</span><span class="n">frequency</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">100000</span><span class="o">&gt;</span><span class="p">;</span>
	<span class="n">pinctrl</span><span class="o">-</span><span class="n">names</span> <span class="o">=</span> <span class="s">"default"</span><span class="p">;</span>
	<span class="n">pinctrl</span><span class="o">-</span><span class="mi">0</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">pinctrl_i2c1</span><span class="o">&gt;</span><span class="p">;</span>
 	<span class="n">status</span> <span class="o">=</span> <span class="s">"okay"</span><span class="p">;</span>


	<span class="n">i2c_mpu6050</span><span class="err">@</span><span class="mi">68</span> <span class="p">{</span>
		<span class="n">compatible</span> <span class="o">=</span> <span class="s">"jie,i2c_mpu6050"</span><span class="p">;</span>
 		<span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x68</span><span class="o">&gt;</span><span class="p">;</span>
		<span class="n">position</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>

	<span class="p">};</span>
<span class="p">};</span>

</code></pre></div></div>

<p>The following part is the framework of a i2c driver. The start flow can be simplified as:</p>

<ol>
  <li>register the i2c driver inside initial function</li>
  <li>if driver match with the device, it goes into <code class="highlighter-rouge">.probe</code> function</li>
  <li>inside <code class="highlighter-rouge">.probe</code> register your i2c device (register,bind,add,initial).</li>
  <li>running the file operation function(open,release,write, read, etc.)</li>
</ol>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
</pre></td><td class="code"><pre><span class="cp">#include &lt;linux/types.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/delay.h&gt;
#include &lt;linux/ide.h&gt;
#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/errno.h&gt;
#include &lt;linux/gpio.h&gt;
#include &lt;linux/cdev.h&gt;
#include &lt;linux/device.h&gt;
#include &lt;linux/of_gpio.h&gt;
#include &lt;linux/semaphore.h&gt;
#include &lt;linux/timer.h&gt;
#include &lt;linux/i2c.h&gt;
#include &lt;asm/mach/map.h&gt;
#include &lt;asm/uaccess.h&gt;
#include &lt;asm/io.h&gt;
</span>

<span class="k">struct</span> <span class="n">mpu6050_dev</span> <span class="p">{</span> 
    <span class="n">dev_t</span> <span class="n">devid</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">cdev</span> <span class="n">cdev</span><span class="p">;</span> <span class="cm">/* cdev */</span>
    <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">class</span><span class="p">;</span> <span class="cm">/* class */</span>
    <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span> <span class="cm">/* device */</span>
    <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span> <span class="n">dev_node</span><span class="p">;</span> <span class="cm">/* device_node */</span>
    <span class="kt">int</span> <span class="n">major</span><span class="p">;</span> <span class="cm">/* major deviceid */</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">;</span> <span class="cm">/* data */</span>

    <span class="kt">short</span> <span class="n">mpu6050_result</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span> <span class="cm">/* 6 aixs gyro and accel data */</span>
<span class="p">};</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpu6050_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>

    <span class="cm">/* TODO*/</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mpu6050_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpu6050_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> 

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mpu6050_chr_dev_fops</span> <span class="o">=</span>
    <span class="p">{</span>
            <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
            <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">mpu6050_open</span><span class="p">,</span>
            <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">mpu6050_read</span><span class="p">,</span>
            <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">mpu6050_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpu6050_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpu6050_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">gtp_device_id</span><span class="p">[]</span> <span class="o">=</span><span class="p">{</span>
    <span class="p">{</span><span class="s">"jie,i2c_mpu6050"</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
    <span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpu6050_match_table</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
    <span class="p">{.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">"jie,i2c_mpu6050"</span><span class="p">},</span>
    <span class="p">{</span><span class="cm">/* Sentinel */</span><span class="p">}</span>
<span class="p">};</span>



<span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">mpu6050_driver</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">mpu6050_probe</span><span class="p">,</span>
    <span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">mpu6050_remove</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">gtp_device_id</span><span class="p">,</span>
    <span class="p">.</span><span class="n">driver</span> <span class="o">=</span><span class="p">{</span>
            <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"mpu6050"</span><span class="p">,</span>
            <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
            <span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">mpu6050_match_table</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mpu6050_driver_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"mpu6050_driver_init"</span><span class="p">);</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpu6050_driver</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mpu6050_driver_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"mpu6050_driver_exit"</span><span class="p">);</span>
    <span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpu6050_driver</span><span class="p">);</span>
        

<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">mpu6050_driver_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mpu6050_driver_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="2-driver-with-device-tree-and-platform">2. Driver with device tree and platform</h2>
<p>Platform bus can be seen as a kind of virtual bus, and the usage of platform bus is very similar with normal <b>BUS</b>.</p>

<h3 id="21">2.1</h3>



									<br/>
									<h3><i class="fas fa-tags"></i>Post Tags</h3>
									
									<a href=" ../../../../tag/linux/index.html" >Linux</a>
									
									<a href=" ../../../../tag/kernel/index.html" >kernel</a>
									
									<a href=" ../../../../tag/device-tree/index.html" >Device-tree</a>
									
									<head>
<script src='https://unpkg.com/valine/dist/Valine.min.js'></script>
</head>

<div id="vcomments"></div>
<script>
    new Valine({
        el: '#vcomments',
        appId: '9CvJWlMvXQsUUkjcCF0nbtSS-MdYXbMMI',
        appKey: 'KQFufTHJeHucASskKMC6xtLG',
        avatar: 'retro',
        meta: ['nick', 'mail'],
        lang: 'en',
        visitor: true,
        enableQQ:true,
        placeholder: 'Message here.\n (Tips: To make a anonymous comment, nickname and email are not necessary.\n Please entry nickname and email, if you want to show your nickname and get reminder of reply by email. )\n(输入nickname和email，可显示网络名并得到邮件回复提醒。)'
    })
</script>

								</section>
								
								

								

							</div>
						</div>
								

								
								
								

				<!-- Sidebar -->



					<div id="sidebar">
						<div class="inner">

							<!-- Search -->
								<section id="search" class="alt">
									<form method="post" action="#">
										<input type="text" name="query" id="query" placeholder="Search" />
									</form>
								</section>





							<!-- Menu -->
								<nav id="menu">
									<header class="major">
										<h2>Menu</h2>
									</header>
									<ul>
									<li><a href="../../../../index.html">About me</a></li>
									<li>


											<span class="opener">Photograph</span>
											<ul>
												

												<li><a href="../../../../photos/toronto/index.html">toronto</a></li>
												

												<li><a href="../../../../photos/windsor/index.html">windsor</a></li>
												
											</ul>
									</li>	
									</ul>
									<br/>
										
									<header class="major">
									<h2>Tech Blogs</h2>
									</header>	
									<ul>
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										<li>
											<a href="/2020/05/12/robotics.html">Robotics</a><span class="opener" style="font-size: 0.1;"></span>
											<ul>
												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

																						
												
												

												<li><a href="/2019/12/12/formation-control.html">Formation Control</a></li>
												
												
												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												<!--<li><a href="#">Feugiat Veroeros</a></li> -->
											</ul>
										</li>
										
										
										
										
										
										<li>
											<a href="/2020/05/12/programming.html">Programming</a><span class="opener" style="font-size: 0.1;"></span>
											<ul>
												
												
												

																						
												
												

												<li><a href="/2020/08/06/c_cpp.html"> C++ STL container</a></li>
												
												
												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

																						
												
												

												<li><a href="/2019/12/12/TCPlinux.html"> Socket(TCP/UDP) use note in linux</a></li>
												
												
												
												
												

																						
												
												

												<li><a href="/2019/12/12/SQL.html"> SQL command and usage </a></li>
												
												
												
												
												

																						
												
												

												<li><a href="/2019/12/12/makefile.html"> Makefile</a></li>
												
												
												
												
												

																						
												
												
												
												
												
												

																						
												
												

												<li><a href="/2019/12/12/c_cpp_scope.html"> C/C++ Scope, Storage, and Linkage</a></li>
												
												
												
												
												

																						
												
												
												
												
												
												

																						
												
												

												<li><a href="/2019/12/12/c_cpp_STL.html"> C++ STL container</a></li>
												
												
												
												
												

												
												
												

												
												
												<!--<li><a href="#">Feugiat Veroeros</a></li> -->
											</ul>
										</li>
										
										
										
										
										
										<li>
											<a href="/2020/05/12/mcu.html">Mcu&Mpu</a><span class="opener" style="font-size: 0.1;"></span>
											<ul>
												
												
												

												
												
												

																						
												
												

												<li><a href="/2020/07/04/driver-framework.html">Linux -- Driver framework</a></li>
												
												
												
												
												

												
												
												

												
												
												

												
												
												

																						
												
												

												<li><a href="/2020/06/12/Uboot.html">Uboot porting with NXP MX serie</a></li>
												
												
												
												
												

																						
												
												

												<li><a href="/2020/06/12/FreeRTOS.html">Framework of FreeRTOS</a></li>
												
												
												
												
												

																						
												
												

												<li><a href="/2020/05/25/kernel-dts.html">Linux DTB -- device tree</a></li>
												
												
												
												
												

																						
												
												

												<li><a href="/2020/05/25/kernel.html">Linux kernel module beginning (I)</a></li>
												
												
												
												
												

																						
												
												

												<li><a href="/2020/05/25/embedded_linux.html">Embedded linux system architecture</a></li>
												
												
												
												
												

																						
												
												

												<li><a href="/2020/05/22/interrupt.html">Interrupt of ARM A7</a></li>
												
												
												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												<!--<li><a href="#">Feugiat Veroeros</a></li> -->
											</ul>
										</li>
										
										
										
										
										
										<li>
											<a href="/2020/05/12/Machine-Vision.html">Machine Vision</a><span class="opener" style="font-size: 0.1;"></span>
											<ul>
												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

																						
												
												

												<li><a href="/2019/12/12/QRcode.html">Usage of QR code in ROS</a></li>
												
												
												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												<!--<li><a href="#">Feugiat Veroeros</a></li> -->
											</ul>
										</li>
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
												
												

												
												
												

												
												
												

																						
												
												
												
												

																						
												
												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

																						
												
												
												
												

																						
												
												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												

												
												
												<!--<li><a href="#">Feugiat Veroeros</a></li> -->
											</ul>
										</li>
										
										
										
										
										
										<br/>
										<!--<li><a href="elements.html">Elements</a></li>-->
										<!--<li><a href="elements.html">Elements</a></li>-->
										
										
									</ul>

									<div>
										<h3><a href=" "><i class="fas fa-tags"></i>Tags</h3></a>
									</div>
									
									
									
									
									

									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/c++/index.html" style="font-size: 13.5pt; color: #444;">C++</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/中文/index.html" style="font-size: 16pt; color: #222;">中文</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/makefile/index.html" style="font-size: 9pt; color: #999;">Makefile</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/sql/index.html" style="font-size: 9pt; color: #999;">SQL</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/c/index.html" style="font-size: 9pt; color: #999;">C</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/tcp/index.html" style="font-size: 9pt; color: #999;">TCP</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/ros/index.html" style="font-size: 11.5pt; color: #777;">ROS</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/robotics/index.html" style="font-size: 9pt; color: #999;">Robotics</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/localization/index.html" style="font-size: 11.5pt; color: #777;">Localization</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/formation-control/index.html" style="font-size: 9pt; color: #999;">Formation-control</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/qrcode/index.html" style="font-size: 9pt; color: #999;">QRcode</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/camera-model/index.html" style="font-size: 9pt; color: #999;">Camera-model</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/notes/index.html" style="font-size: 18pt; color: #000;">Notes</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/arm/index.html" style="font-size: 9pt; color: #999;">ARM</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/interrupt/index.html" style="font-size: 9pt; color: #999;">interrupt</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/bare-metal/index.html" style="font-size: 9pt; color: #999;">bare-metal</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/linux/index.html" style="font-size: 18pt; color: #000;">Linux</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/uboot/index.html" style="font-size: 11.5pt; color: #777;">Uboot</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/dirver/index.html" style="font-size: 11.5pt; color: #777;">Dirver</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/kernel/index.html" style="font-size: 13.5pt; color: #444;">kernel</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/device-tree/index.html" style="font-size: 11.5pt; color: #777;">Device-tree</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/rtos/index.html" style="font-size: 9pt; color: #999;">RTOS</a>
									  
									
									  
									  
									  
									  
									  

									  
									  <a href=" ../../../../tag/freertos/index.html" style="font-size: 9pt; color: #999;">FreeRTOS</a>
									  
									
									

								</nav>


								<!-- 
								

								
								 
								  
								    <a href="/2020/05/22/interrupt.html">ARM</a>
								  
								  
								
								 
								  
								    <a href="/2019/12/12/TCPlinux.html">C</a>
								  
								  
								
								 
								  
								    <a href="/2020/08/06/c_cpp.html">C++</a>
								  
								    <a href="/2019/12/12/c_cpp_scope.html">C++</a>
								  
								    <a href="/2019/12/12/c_cpp_STL.html">C++</a>
								  
								  
								
								 
								  
								    <a href="/2019/12/12/QRcode.html">Camera-model</a>
								  
								  
								
								 
								  
								    <a href="/2020/07/04/driver-framework.html">Device-tree</a>
								  
								    <a href="/2020/05/25/kernel-dts.html">Device-tree</a>
								  
								  
								
								 
								  
								    <a href="/2020/05/25/kernel.html">Dirver</a>
								  
								    <a href="/2020/05/25/embedded_linux.html">Dirver</a>
								  
								  
								
								 
								  
								    <a href="/2019/12/12/formation-control.html">Formation-control</a>
								  
								  
								
								 
								  
								    <a href="/2020/06/12/FreeRTOS.html">FreeRTOS</a>
								  
								  
								
								 
								  
								    <a href="/2020/07/04/driver-framework.html">Linux</a>
								  
								    <a href="/2020/06/12/Uboot.html">Linux</a>
								  
								    <a href="/2020/05/25/kernel-dts.html">Linux</a>
								  
								    <a href="/2020/05/25/kernel.html">Linux</a>
								  
								    <a href="/2020/05/25/embedded_linux.html">Linux</a>
								  
								  
								
								 
								  
								    <a href="/2019/12/12/QRcode.html">Localization</a>
								  
								    <a href="/2019/12/12/formation-control.html">Localization</a>
								  
								  
								
								 
								  
								    <a href="/2019/12/12/makefile.html">Makefile</a>
								  
								  
								
								 
								  
								    <a href="/chinese/linux_command.html">Notes</a>
								  
								    <a href="/chinese/dts.html">Notes</a>
								  
								    <a href="/chinese/linux_bug.html">Notes</a>
								  
								    <a href="/2020/05/12/knowledge.html">Notes</a>
								  
								    <a href="/2020/05/12/Cricuit.html">Notes</a>
								  
								  
								
								 
								  
								    <a href="/2019/12/12/QRcode.html">QRcode</a>
								  
								  
								
								 
								  
								    <a href="/2019/12/12/QRcode.html">ROS</a>
								  
								    <a href="/2019/12/12/formation-control.html">ROS</a>
								  
								  
								
								 
								  
								    <a href="/2020/06/12/FreeRTOS.html">RTOS</a>
								  
								  
								
								 
								  
								    <a href="/2019/12/12/formation-control.html">Robotics</a>
								  
								  
								
								 
								  
								    <a href="/2019/12/12/SQL.html">SQL</a>
								  
								  
								
								 
								  
								    <a href="/2019/12/12/TCPlinux.html">TCP</a>
								  
								  
								
								 
								  
								    <a href="/2020/06/12/Uboot.html">Uboot</a>
								  
								    <a href="/2020/05/25/embedded_linux.html">Uboot</a>
								  
								  
								
								 
								  
								    <a href="/2020/05/22/interrupt.html">bare-metal</a>
								  
								  
								
								 
								  
								    <a href="/2020/05/22/interrupt.html">interrupt</a>
								  
								  
								
								 
								  
								    <a href="/2020/07/04/driver-framework.html">kernel</a>
								  
								    <a href="/2020/05/25/kernel-dts.html">kernel</a>
								  
								    <a href="/2020/05/25/kernel.html">kernel</a>
								  
								  
								
								 
								  
								    <a href="/chinese/dts.html">中文</a>
								  
								    <a href="/2020/05/12/knowledge.html">中文</a>
								  
								    <a href="/chinese/C_Cpp_scope.html">中文</a>
								  
								    <a href="/chinese/C_Cpp_STL.html">中文</a>
								  
								  
								 -->
							
							<!-- Footer -->
								<footer id="footer">
									<p class="copyright">&copy; Jietang. All rights reserved.</p>
								</footer>

						</div>
					</div>

			</div>

		<!-- Scripts -->
			<script src="../../../../assets/js/jquery.min.js"></script>
			<script src="../../../../assets/js/browser.min.js"></script>
			<script src="../../../../assets/js/breakpoints.min.js"></script>
			<script src="../../../../assets/js/util.js"></script>
			<script src="../../../../assets/js/main.js"></script>

	</body>
</html>